<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utopia HomePage 静态页面生成器</title>
    <style>
        :root { --primary: #6750A4; --bg: #f5f5f5; --card-bg: #fff; --border: #ddd; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; gap: 20px; height: 100vh; box-sizing: border-box; }
        
        .sidebar { width: 250px; display: flex; flex-direction: column; gap: 10px; }
        .main-editor { flex: 1; background: var(--card-bg); border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; font-size: 14px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-outline { border: 1px solid var(--primary); color: var(--primary); background: transparent; }
        .btn-outline:hover { background: rgba(103, 80, 164, 0.05); }
        .btn-danger { background: #fee; color: #d32f2f; }
        .btn-sm { padding: 4px 8px; font-size: 12px; }
        .btn-group { display: flex; gap: 5px; }

        .form-section { display: none; }
        .form-section.active { display: block; animation: fadeIn 0.3s; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; color: #333; }
        input[type="text"], input[type="url"], textarea { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        textarea { min-height: 100px; resize: vertical; font-family: monospace; font-size: 13px; }
        input[type="checkbox"] { transform: scale(1.2); margin-right: 5px; cursor: pointer; }
        .checkbox-label { display: flex; align-items: center; cursor: pointer; }
        
        /* 列表项样式调整 */
        .list-item { border: 1px solid var(--border); padding: 15px; border-radius: 6px; margin-bottom: 10px; background: #fafafa; position: relative; transition: opacity 0.3s; }
        .list-item.item-hidden { opacity: 0.6; border: 1px dashed #bbb; background: #eee; }
        
        .list-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .list-item-title { font-weight: bold; color: var(--primary); }
        .sub-list { margin-top: 10px; padding-left: 15px; border-left: 2px solid var(--border); }

        .nav-item { padding: 12px 15px; background: var(--card-bg); border-radius: 6px; cursor: pointer; color: #555; transition: 0.2s; border: 1px solid transparent; }
        .nav-item:hover { background: #fff; border-color: var(--primary); }
        .nav-item.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .warning-box { background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 13px; }

        .visibility-toggle { display: inline-flex; align-items: center; font-size: 12px; color: #666; cursor: pointer; margin-right: 10px; user-select: none; }
        .visibility-toggle input { margin-right: 4px; transform: scale(1.1); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .toolbar { padding-bottom: 15px; margin-bottom: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .status-msg { font-size: 12px; color: #666; margin-left: 10px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2 style="margin: 0 0 10px 0; color: var(--primary);">Utopia HomePage</h2>
    <div class="nav-item active" onclick="switchTab('meta')">基础设置 & CSS/JS</div>
    <div class="nav-item" onclick="switchTab('seo')">SEO 元数据</div>
    <div class="nav-item" onclick="switchTab('badges')">顶部徽标</div>
    <div class="nav-item" onclick="switchTab('categories')">分类与链接</div>
    <div class="nav-item" onclick="switchTab('footer')">页脚信息</div>
    
    <div style="margin-top: auto; border-top: 1px solid #ddd; padding-top: 15px;">
        <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileSelect(event)">
        <button class="btn btn-outline" style="width: 100%; margin-bottom: 10px;" onclick="document.getElementById('fileInput').click()">导入 data.json</button>
        <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="saveJson()">保存 data.json</button>
        <button class="btn btn-primary" style="width: 100%; background: #2e7d32;" onclick="generateHtml()">生成 index.html</button>
    </div>
</div>

<div class="main-editor">
    <div class="toolbar">
        <h3 id="sectionTitle" style="margin:0">基础设置</h3>
        <span id="statusMsg" class="status-msg">准备就绪</span>
    </div>

    <div id="tab-meta" class="form-section active">
        <div class="warning-box">注意：在自定义 CSS/JS 中，请<b>不要使用双斜杠 <code>//</code> 单行注释</b>，这会导致压缩后代码错误。请使用 <code>/* 注释 */</code>。</div>
        <div class="form-group">
            <label>视觉标题</label>
            <input type="text" id="meta_title" oninput="updateConfig('meta', 'title', this.value)" placeholder="页面中间显示的大标题">
        </div>
        <div class="form-group">
            <label>浏览器标签标题</label>
            <input type="text" id="meta_browserTitle" oninput="updateConfig('meta', 'browserTitle', this.value)" placeholder="浏览器标签页显示的标题 (留空则同上)">
        </div>
        <div class="form-group">
            <label>自定义 CSS</label>
            <textarea id="meta_customCSS" style="min-height: 150px;" placeholder="body { background: #000; }" oninput="updateConfig('meta', 'customCSS', this.value)"></textarea>
        </div>
        <div class="form-group">
            <label>自定义 JS</label>
            <textarea id="meta_customJS" placeholder="<script>...</script>" oninput="updateConfig('meta', 'customJS', this.value)"></textarea>
        </div>
    </div>

    <div id="tab-seo" class="form-section">
        <div class="form-group">
            <label>作者</label>
            <input type="text" id="seo_author" oninput="updateConfig('seo', 'author', this.value)">
        </div>
        <div class="form-group">
            <label>关键词</label>
            <input type="text" id="seo_keywords" placeholder="导航, 主页, ..." oninput="updateConfig('seo', 'keywords', this.value)">
        </div>
        <div class="form-group">
            <label>描述</label>
            <textarea id="seo_description" style="min-height: 80px;" oninput="updateConfig('seo', 'description', this.value)"></textarea>
        </div>
        <div class="form-group">
            <label>Robots 规则</label>
            <input type="text" id="seo_robots" placeholder="index, follow" oninput="updateConfig('seo', 'robots', this.value)">
        </div>
    </div>

    <div id="tab-badges" class="form-section">
        <div id="badgesList"></div>
        <button class="btn btn-outline" onclick="addBadge()">+ 添加徽标</button>
    </div>

    <div id="tab-categories" class="form-section">
        <div class="warning-box">提醒：可以勾选每个条目前的复选框来控制其显示与否。如果勾选则会生成HTML，如果不勾选则只会保存在JSON中。</div>
        <div id="categoriesList"></div>
        <button class="btn btn-outline" onclick="addCategory()">+ 添加分类</button>
    </div>

    <div id="tab-footer" class="form-section">
        <div style="background: #eef; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 13px; color: #555;">
            固定标识：Made by Utopia HomePage powered by UtopiaXC
        </div>
        
        <div class="form-group">
            <label>版权起始年份</label>
            <input type="text" id="footer_year" oninput="updateConfig('footer', 'copyrightYearStart', this.value)">
        </div>
        <div class="form-group">
            <label>版权所有者</label>
            <input type="text" id="footer_name" oninput="updateConfig('footer', 'copyrightName', this.value)">
        </div>
        <div class="form-group">
            <label>版权链接</label>
            <input type="text" id="footer_link" oninput="updateConfig('footer', 'copyrightLink', this.value)">
        </div>
        <div class="form-group">
            <label>建站时间 (用于"已稳定运行"计时器)</label>
            <input type="text" id="footer_startDate" placeholder="YYYY-MM-DD HH:mm:ss" oninput="updateConfig('footer', 'startDate', this.value)">
        </div>
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="footer_showRunTime" onchange="updateConfig('footer', 'showRunTime', this.checked)">
                显示"已稳定运行"计时器
            </label>
        </div>
        <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">

        <div class="form-group">
            <label>备案信息 (HTML)</label>
            <textarea id="footer_beian" oninput="updateConfig('footer', 'beianHTML', this.value)"></textarea>
        </div>
        <label>赞助商图标</label>
        <div id="sponsorsList"></div>
        <button class="btn btn-outline" style="margin-top:10px" onclick="addSponsor()">+ 添加赞助商</button>
    </div>
</div>

<script>
const DEFAULT_CONFIG = {
    meta: { title: "", browserTitle: "", customJS: "", customCSS: "" },
    seo: { author: "", keywords: "", description: "", robots: "" },
    headerBadges: [],
    categories: [],
    footer: { 
        copyrightYearStart: "1970", 
        copyrightName: "", 
        copyrightLink: "",
        startDate: "1970-01-01 00:00:00",
        showRunTime: true,
        sponsors: [], 
        beianHTML: "" 
    }
};

let config = JSON.parse(JSON.stringify(DEFAULT_CONFIG));

window.onload = async () => {
    try {
        const res = await fetch('./data.json');
        if (res.ok) config = await res.json();
        else showStatus("未找到本地文件");
    } catch (e) { showStatus("请手动导入 data.json"); }
    
    // 初始化/兼容性处理
    if(!config.seo) config.seo = { author: "", keywords: "", description: "", robots: "" };
    if(typeof config.meta.customCSS === 'undefined') config.meta.customCSS = "";
    if(typeof config.meta.browserTitle === 'undefined') config.meta.browserTitle = ""; // 兼容旧版
    if(typeof config.footer.startDate === 'undefined' && config.meta.startDate) {
        config.footer.startDate = config.meta.startDate; 
    }
    renderAll();
};

function renderAll() {
    document.getElementById('meta_title').value = config.meta.title || '';
    document.getElementById('meta_browserTitle').value = config.meta.browserTitle || '';
    document.getElementById('meta_customJS').value = config.meta.customJS || '';
    document.getElementById('meta_customCSS').value = config.meta.customCSS || '';
    document.getElementById('seo_author').value = config.seo.author || '';
    document.getElementById('seo_keywords').value = config.seo.keywords || '';
    document.getElementById('seo_description').value = config.seo.description || '';
    document.getElementById('seo_robots').value = config.seo.robots || '';
    document.getElementById('footer_year').value = config.footer.copyrightYearStart || '';
    document.getElementById('footer_name').value = config.footer.copyrightName || '';
    document.getElementById('footer_link').value = config.footer.copyrightLink || '';
    document.getElementById('footer_showRunTime').checked = config.footer.showRunTime !== false;
    document.getElementById('footer_beian').value = config.footer.beianHTML || '';
    document.getElementById('footer_startDate').value = config.footer.startDate || '';

    renderBadges();
    renderCategories();
    renderSponsors();
}

function simpleMinify(code) {
    if (!code) return "";
    return code
        .replace(/\/\*[\s\S]*?\*\//g, '')
        .replace(/\r?\n|\r/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
}

function generateHtml() {
    const BASE_CSS = `:root{--primary:#6750A4;--bg-body:#ecf0f3;--text-main:#6750A4;--text-sec:#444;--text-meta:#777;--neu-shadow:9px 9px 16px #cbced1, -9px -9px 16px #ffffff;--neu-shadow-hover:5px 5px 10px #cbced1, -5px -5px 10px #ffffff;--toggle-track-shadow:inset 5px 5px 10px #cbced1, inset -5px -5px 10px #ffffff;--link-underline:rgba(103, 80, 164, 0.3)}[data-theme=dark]{--primary:#bb9af7;--bg-body:#1a1b26;--text-main:#c0caf5;--text-sec:#9aa5ce;--text-meta:#565f89;--fw-title:300;--fw-desc:300;--neu-shadow:8px 8px 16px rgba(0, 0, 0, 0.3), -8px -8px 16px rgba(255, 255, 255, 0.05);--neu-shadow-hover:5px 5px 10px rgba(0, 0, 0, 0.3), -5px -5px 10px rgba(255, 255, 255, 0.05);--toggle-track-shadow:inset 4px 4px 8px rgba(0, 0, 0, 0.3), inset -4px -4px 8px rgba(255, 255, 255, 0.05);--link-underline:rgba(187, 154, 247, 0.3)}*{box-sizing:border-box;transition:all .3s cubic-bezier(.25,.8,.25,1)}body{margin:0;font-family:miranafont,"Hiragino Sans GB",STXihei,"Microsoft YaHei",SimSun,sans-serif;font-weight:500;background-color:var(--bg-body);color:var(--text-main);line-height:1.4;font-size:16px;min-height:100vh;display:flex;flex-direction:column}a{text-decoration:none;color:inherit}::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:0 0}::-webkit-scrollbar-thumb{background:var(--text-meta);border-radius:10px;opacity:.3}.wrapper{flex:1;display:flex;flex-direction:column}.site-content{width:100%;max-width:860px;margin:0 auto;padding:40px 20px;flex:1}.header-top-bar{display:flex;justify-content:flex-end;margin-bottom:20px;padding-top:20px}.header-area{text-align:center;margin-bottom:80px;margin-top:80px}.brand-title{font-size:2.4rem;font-weight:300;letter-spacing:8px;color:var(--primary);margin-bottom:30px;display:inline-block;text-shadow:1px 1px 2px rgba(0,0,0,.1)}.friend-links{display:flex;justify-content:center;gap:25px;align-items:center}.img_link_group img{height:22px;width:auto;display:none;opacity:.8;transition:transform .3s,opacity .3s;filter:drop-shadow(1px 1px 2px rgba(0,0,0,.1))}.img_link_group:hover img{opacity:1;transform:scale(1.1)}html:not([data-theme=dark]) .img_random_link_day{display:block}html[data-theme=dark] .img_random_link_night{display:block}.theme-switch{position:relative;display:inline-block;width:60px;height:30px}.theme-switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--bg-body);border-radius:34px;box-shadow:var(--toggle-track-shadow);display:flex;align-items:center;justify-content:space-between;padding:0 8px}.slider:before{position:absolute;content:"";height:22px;width:22px;left:4px;bottom:4px;background-color:var(--bg-body);border-radius:50%;box-shadow:var(--neu-shadow);transition:.4s cubic-bezier(.25,.8,.25,1);z-index:2}input:checked+.slider:before{transform:translateX(30px);background-color:var(--primary);box-shadow:2px 2px 5px rgba(0,0,0,.2),-2px -2px 5px rgba(255,255,255,.1)}.icon-visual{width:14px;height:14px;fill:var(--text-meta);z-index:1;opacity:.8;transition:opacity .3s}input:checked+.slider .icon-sun,input:not(:checked)+.slider .icon-moon{opacity:.4}.category-header{margin-top:60px;margin-bottom:25px}.category-header h2{font-size:1.4rem;color:var(--text-sec);font-weight:800;margin:0;display:flex;align-items:center;white-space:pre-wrap;letter-spacing:1px}.category-header h2::before{content:"#";margin-right:8px;color:var(--primary);opacity:.7;font-weight:300}.category-header h2 a{color:var(--primary);border-bottom:2px dotted var(--link-underline);padding-bottom:1px;transition:border-bottom-color .3s}.category-header h2 a:hover{border-bottom-color:var(--primary)}.category-header hr{border:0;height:2px;background:linear-gradient(to right,var(--primary),transparent);margin-top:12px;opacity:.3;border-radius:2px}.link-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:25px}.link-card{background-color:var(--bg-body);border-radius:20px;padding:20px 24px;display:flex;flex-direction:column;justify-content:center;box-shadow:var(--neu-shadow);border:none;position:relative}.link-card:hover{transform:translateY(-2px);box-shadow:var(--neu-shadow-hover)}.link-card::after{content:'';position:absolute;left:12px;top:50%;transform:translateY(-50%);height:60%;width:4px;background:var(--primary);border-radius:4px;opacity:0;transition:opacity .3s}.link-card:hover::after{opacity:.8}.link-card .site-name{display:block;font-size:1.1rem;font-weight:600;color:var(--text-main);margin-bottom:6px;margin-left:8px;transition:margin-left .3s}.link-card:hover .site-name{color:var(--primary);margin-left:16px}.link-card .site-desc{font-size:.8rem;color:var(--text-meta);line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;height:3em;margin-left:8px;transition:margin-left .3s;font-weight:600}.link-card:hover .site-desc{margin-left:16px}.site-footer{margin-top:80px;padding:40px 20px;text-align:center;font-size:.85rem;font-weight:600;color:var(--text-meta);box-shadow:0 -5px 10px rgba(0,0,0,.02)}.site-footer a{color:var(--text-sec);font-weight:600;border-bottom:1px dotted var(--link-underline);transition:color .3s,border-bottom-color .3s}.site-footer a:hover{color:var(--primary);border-bottom-color:var(--primary)}.footer-icons{margin-top:15px}.footer-icons img{height:16px;vertical-align:middle;margin:0 8px;transition:transform .3s;filter:drop-shadow(0 1px 1px rgba(0,0,0,.1));border-bottom:none}.footer-icons a{border-bottom:none}.footer-icons img:hover{transform:scale(1.2)}.beian-info{margin-top:15px;font-size:.75rem;opacity:.7}.beian-info a{border-bottom:none}#survive_days{color:var(--primary)}@media (max-width:600px){.site-content{padding:20px 15px}.link-grid{grid-template-columns:1fr}.brand-title{font-size:1.8rem;letter-spacing:6px}}`;

    const badgesHtml = config.headerBadges
        .filter(b => b.visible !== false)
        .map(b => `<a href="${b.url}" title="${b.title}" class="img_link_group" style="border:none"><img class="img_random_link_day" src="${b.imgDay}" alt="${b.title}"><img class="img_random_link_night" src="${b.imgNight}" alt="${b.title}"></a>`)
        .join('');

    const contentHtml = config.categories
        .filter(cat => cat.visible !== false)
        .map(cat => {
            const visibleLinks = cat.links
                .filter(link => link.visible !== false)
                .map(link => `<a href="${link.url}" target="_blank" class="link-card" title="${link.desc}"><span class="site-name">${link.name}</span><div class="site-desc">${link.desc}</div></a>`)
                .join('');
            
            return `<div class="category-header"><h2>${cat.name}</h2><hr></div><div class="link-grid">${visibleLinks}</div>`;
        })
        .join('');

    const sponsorsHtml = config.footer.sponsors
        .filter(s => s.visible !== false)
        .map(s => `<a href="${s.url}" target="_blank"><img src="${s.img}" alt="${s.title}" title="${s.title}"></a>`)
        .join('');
    
    // 逻辑：使用 browserTitle，如果为空则使用 title
    const finalBrowserTitle = config.meta.browserTitle || config.meta.title;

    let seoMeta = "";
    if(config.seo.author) seoMeta += `<meta name="author" content="${config.seo.author}">`;
    if(config.seo.keywords) seoMeta += `<meta name="keywords" content="${config.seo.keywords}">`;
    if(config.seo.description) seoMeta += `<meta name="description" content="${config.seo.description}">`;
    if(config.seo.robots) seoMeta += `<meta name="robots" content="${config.seo.robots}">`;
    const minifiedCustomCSS = simpleMinify(config.meta.customCSS);
    const minifiedCustomJS = simpleMinify(config.meta.customJS);
    const currentYear = new Date().getFullYear();
    const runTimeHtml = config.footer.showRunTime ? '已稳定运行 <span id="survive_days"></span><br>' : '';
    const runTimeScript = config.footer.showRunTime ? `function u(){var t=new Date("${config.footer.startDate}"),n=new Date,e=n-t,o=Math.floor(e/864e5),a=e%864e5,r=Math.floor(a/36e5),c=a%36e5,i=Math.floor(c/6e4),d=Math.floor(c%6e4/1e3),l=t=>String(t).padStart(2,"0"),s=\`\${o}天 \${l(r)}小时 \${l(i)}分 \${l(d)}秒\`,m=document.getElementById("survive_days");m&&(m.innerHTML=s)}setInterval(u,1e3),u();` : '';
    
    // 使用 finalBrowserTitle 作为 title
    let fullHtml = `<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>${finalBrowserTitle}</title>${seoMeta}${minifiedCustomJS}<style>${BASE_CSS}${minifiedCustomCSS}</style></head><body><div class="wrapper"><div class="site-content"><div class="header-top-bar"><div class="friend-links">${badgesHtml}<label class="theme-switch" title="切换昼夜模式"><input type="checkbox" id="themeToggleCheckbox"><span class="slider"><svg class="icon-visual icon-sun" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/></path></svg><svg class="icon-visual icon-moon" viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></path></svg></span></label></div></div><div class="header-area"><div class="brand-title">${config.meta.title}</div></div><article>${contentHtml}</article></div><footer class="site-footer"><div class="site-info">Made by <a href="https://github.com/UtopiaXC/Utopia-HomePage" rel="nofollow" target="_blank">Utopia HomePage</a> powered by <a href="https://www.utopiaxc.cn/" rel="nofollow" target="_blank">UtopiaXC</a>.<br>Copyright © ${config.footer.copyrightYearStart}-${currentYear} <a href="${config.footer.copyrightLink}" rel="nofollow">${config.footer.copyrightName}</a>. All rights reserved.<br>${runTimeHtml}<div class="footer-icons">${sponsorsHtml}</div><div class="beian-info">${config.footer.beianHTML}</div></div></footer></div><script>${simpleMinify(runTimeScript)}!function(){const e=document.getElementById("themeToggleCheckbox"),t=document.documentElement;function n(e){"dark"===e?(t.setAttribute("data-theme","dark"),c.checked=!0):(t.removeAttribute("data-theme"),c.checked=!1)}function o(){return sessionStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}const c=document.getElementById("themeToggleCheckbox");n(o()),c.addEventListener("change",function(){const e=this.checked?"dark":"light";n(e),sessionStorage.setItem("theme",e)}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{sessionStorage.getItem("theme")||n(e.matches?"dark":"light")})}();<\/script></body></html>`;
    downloadFile(fullHtml.replace(/\n\s*/g, ''), 'index.html', 'text/html');
    showStatus("index.html 已生成");
}

function switchTab(tab) {
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.form-section').forEach(el => el.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('tab-' + tab).classList.add('active');
    const titles = { 'meta': '基础设置', 'seo': 'SEO 元数据', 'badges': '顶部徽标', 'categories': '分类与链接', 'footer': '页脚信息' };
    document.getElementById('sectionTitle').innerText = titles[tab];
}

function renderBadges() {
    const container = document.getElementById('badgesList');
    container.innerHTML = '';
    config.headerBadges.forEach((item, index) => {
        container.appendChild(createItemCard(index, item.title, [
            { label: '标题', key: 'title', val: item.title },
            { label: '链接', key: 'url', val: item.url },
            { label: '日间图', key: 'imgDay', val: item.imgDay },
            { label: '夜间图', key: 'imgNight', val: item.imgNight }
        ], 'headerBadges', item));
    });
}
function renderSponsors() {
    const container = document.getElementById('sponsorsList');
    container.innerHTML = '';
    config.footer.sponsors.forEach((item, index) => {
        container.appendChild(createItemCard(index, item.title, [
            { label: '名称', key: 'title', val: item.title },
            { label: '链接', key: 'url', val: item.url },
            { label: '图标', key: 'img', val: item.img }
        ], 'footer.sponsors', item));
    });
}
function renderCategories() {
    const container = document.getElementById('categoriesList');
    container.innerHTML = '';
    config.categories.forEach((cat, catIndex) => {
        const div = document.createElement('div');
        div.className = `list-item ${cat.visible === false ? 'item-hidden' : ''}`;
        
        const visibilityChecked = cat.visible !== false ? 'checked' : '';
        
        div.innerHTML = `
            <div class="list-item-header">
                <div style="display:flex;align-items:center;">
                    <label class="visibility-toggle" title="显示/隐藏此分类">
                        <input type="checkbox" ${visibilityChecked} onchange="toggleItemVisible('categories', ${catIndex})">
                    </label>
                    <input type="text" value="${cat.name.replace(/"/g, '&quot;')}" oninput="updateCategoryName(${catIndex}, this.value)" style="width:180px;font-weight:bold" placeholder="分类名称(支持HTML)">
                </div>
                <div class="btn-group"><button class="btn btn-sm btn-outline" onclick="moveItem('categories', ${catIndex}, -1)">↑</button><button class="btn btn-sm btn-outline" onclick="moveItem('categories', ${catIndex}, 1)">↓</button><button class="btn btn-sm btn-danger" onclick="deleteItem('categories', ${catIndex})">×</button></div>
            </div>
            <div class="sub-list" id="cat-links-${catIndex}"></div>
            <button class="btn btn-sm btn-outline" style="margin-top:10px" onclick="addLink(${catIndex})">+ 添加链接</button>
        `;
        container.appendChild(div);
        const linksContainer = document.getElementById(`cat-links-${catIndex}`);
        cat.links.forEach((link, linkIndex) => {
            linksContainer.appendChild(createItemCard(linkIndex, link.name, [
                { label: '名称', key: 'name', val: link.name },
                { label: '描述', key: 'desc', val: link.desc },
                { label: 'URL', key: 'url', val: link.url }
            ], `categories.${catIndex}.links`, link));
        });
    });
}
function createItemCard(index, title, fields, path, dataItem) {
    const div = document.createElement('div');
    const isVisible = dataItem && dataItem.visible !== false;
    div.className = `list-item ${!isVisible ? 'item-hidden' : ''}`;
    
    let fieldsHtml = fields.map(f => `<div style="margin-top:5px"><label style="font-size:12px;color:#888">${f.label}</label><input type="text" value="${(f.val || '').replace(/"/g, '&quot;')}" oninput="updateDeepValue('${path}', ${index}, '${f.key}', this.value)"></div>`).join('');
    
    div.innerHTML = `
        <div class="list-item-header">
            <span class="list-item-title">${title || '新项目'}</span>
            <div style="display:flex; align-items:center; gap:5px">
                <label class="visibility-toggle" style="margin:0" title="显示/隐藏">
                    <input type="checkbox" ${isVisible ? 'checked' : ''} onchange="toggleItemVisible('${path}', ${index})"> 显示
                </label>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline" onclick="moveItem('${path}', ${index}, -1)">↑</button>
                    <button class="btn btn-sm btn-outline" onclick="moveItem('${path}', ${index}, 1)">↓</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteItem('${path}', ${index})">×</button>
                </div>
            </div>
        </div>
        ${fieldsHtml}`;
    return div;
}

function getDeepRef(path) {
    const parts = path.split('.');
    let ref = config;
    for (let i = 0; i < parts.length - 1; i++) ref = ref[parts[i]];
    return { ref, key: parts[parts.length - 1] };
}
function updateConfig(section, key, value) { config[section][key] = value; }
function updateCategoryName(index, val) { config.categories[index].name = val; }
function updateDeepValue(path, index, key, val) { const { ref, key: arrayKey } = getDeepRef(path); ref[arrayKey][index][key] = val; }

function toggleItemVisible(path, index) {
    const { ref, key: arrayKey } = getDeepRef(path);
    const item = ref[arrayKey][index];
    item.visible = (item.visible === false) ? true : false;
    renderAll();
}

function addBadge() { config.headerBadges.push({ title: "新友链", url: "#", imgDay: "", imgNight: "", visible: true }); renderBadges(); }
function addSponsor() { config.footer.sponsors.push({ title: "新赞助商", url: "#", img: "", visible: true }); renderSponsors(); }
function addCategory() { config.categories.push({ name: "新分类", links: [], visible: true }); renderCategories(); }
function addLink(catIndex) { config.categories[catIndex].links.push({ name: "新链接", desc: "描述", url: "#", visible: true }); renderCategories(); }
function deleteItem(path, index) { if(!confirm("确定删除吗？")) return; const { ref, key } = getDeepRef(path); ref[key].splice(index, 1); renderAll(); }
function moveItem(path, index, direction) { const { ref, key } = getDeepRef(path); const arr = ref[key]; const newIndex = index + direction; if (newIndex < 0 || newIndex >= arr.length) return; [arr[index], arr[newIndex]] = [arr[newIndex], arr[index]]; renderAll(); }
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try { config = JSON.parse(e.target.result); renderAll(); showStatus("导入成功"); } catch(err) { alert("JSON 格式错误"); }
    };
    reader.readAsText(file);
}
function saveJson() { downloadFile(JSON.stringify(config, null, 2), 'data.json', 'application/json'); showStatus("data.json 已生成"); }
function showStatus(msg) { const el = document.getElementById('statusMsg'); el.innerText = msg; el.style.opacity = 1; setTimeout(() => el.style.opacity = 0.5, 3000); }
function downloadFile(content, fileName, mimeType) { const blob = new Blob([content], { type: mimeType }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = fileName; link.click(); URL.revokeObjectURL(link.href); }
</script>
</body>
</html>